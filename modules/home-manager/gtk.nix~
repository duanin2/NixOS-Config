{ config, pkgs, ... }:

with lib;

let
  cfg = config.gtk;

  toGtkIni = generators.toINI {
    mkKeyValue = key: value: let
      value' = if isBool value then boolToString value else toString value;
    in
      "${escape [ "=" ] key}=${value'}";
  };

  formatGtk2Option = n: v: let
    v' = if isBool v then
      boolToString value
    else if isString v then
      ''"${v}"''
    else
      toString v;
  in
    "${escape [ "=" ] n} = ${v'}";

  themeType = types.submodule {
    options = {
      package = mkOption {
        type = types.nullOr types.package;
        default = null;
        example = literalExpression "pkgs.gnome.gnome-themes-extra";
        description = ''
          Package providing the theme. This package will be installed
          to your profile. If `null` then the theme
          is assumed to already be available in your profile.
        '';
      };

      name = mkOption {
        type = types.str;
        example = "Adwaita";
        description = "The name of the theme within the package.";
      };
    };
  };

  iconThemeType = types.submodule {
    options = {
      package = mkOption {
        type = types.nullOr types.package;
        default = null;
        example = literalExpression "pkgs.gnome.adwaita-icon-theme";
        description = ''
          Package providing the icon theme. This package will be installed
          to your profile. If `null` then the theme
          is assumed to already be available in your profile.
        '';
      };

      name = mkOption {
        type = types.str;
        example = "Adwaita";
        description = "The name of the icon theme within the package.";
      };
    };
  };

  cursorThemeType = types.submodule {
    options = {
      package = mkOption {
        type = types.nullOr types.package;
        default = null;
        example = literalExpression "pkgs.vanilla-dmz";
        description = ''
          Package providing the cursor theme. This package will be installed
          to your profile. If `null` then the theme
          is assumed to already be available in your profile.
        '';
      };

      name = mkOption {
        type = types.str;
        example = "Vanilla-DMZ";
        description = "The name of the cursor theme within the package.";
      };

      size = mkOption {
        type = types.nullOr types.int;
        default = null;
        example = 16;
        description = ''
          The size of the cursor.
        '';
      };
    };
  };
in {
  disabledModules = [ "misc/gtk.nix" ];

  options.gtk = {
    enable = mkEnableOption "GTK configuration";

    font = mkOption {
      type = types.nullOr hm.types.fontType;
      default = null;
      description = "The font to use.";
    };

    cursorTheme = mkOption {
      type = types.nullOr cursorThemeType;
      default = null;
      description = "The cursor theme to use.";
    };

    iconTheme = mkOption {
      type = types.nullOr iconThemeType;
      default = null;
      description = "The icon theme to use.";
    };

    theme = mkOption {
      type = types.nullOr themeType;
      default = null;
      description = "The GTK theme to use.";
    };

    preferDarkTheme = mkOption {
      type = types.boolean;
      default = false;
      description = "Whether to use a dark theme or not.";
    };
  };

  config = mkIf cfg.enable (let
    gtk4Ini = optionalAttrs (cfg.font != null) {
      gtk-font-name = let
        fontSize =
          optionalString (cfg.font.size != null) " ${toString cfg.font.size}";
      in "${cfg.font.name}" + fontSize;
    } // optionalAttrs (cfg.theme != null) { gtk-theme-name = cfg.theme.name; }
    // optionalAttrs (cfg.iconTheme != null) {
      gtk-icon-theme-name = cfg.iconTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null) {
      gtk-cursor-theme-name = cfg.cursorTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null && cfg.cursorTheme.size != null) {
      gtk-cursor-theme-size = cfg.cursorTheme.size;
    } // {
      gtk-application-prefer-dark-theme = cfg.preferDarkTheme;
    };

    gtk3Ini = optionalAttrs (cfg.font != null) {
      gtk-font-name = let
        fontSize =
          optionalString (cfg.font.size != null) " ${toString cfg.font.size}";
      in "${cfg.font.name}" + fontSize;
    } // optionalAttrs (cfg.theme != null) { gtk-theme-name = cfg.theme.name; }
    // optionalAttrs (cfg.iconTheme != null) {
      gtk-icon-theme-name = cfg.iconTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null) {
      gtk-cursor-theme-name = cfg.cursorTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null && cfg.cursorTheme.size != null) {
      gtk-cursor-theme-size = cfg.cursorTheme.size;
    } // {
      gtk-application-prefer-dark-theme = cfg.preferDarkTheme;
    };

    gtk2Ini = optionalAttrs (cfg.font != null) {
      gtk-font-name = let
        fontSize =
          optionalString (cfg.font.size != null) " ${toString cfg.font.size}";
      in "${cfg.font.name}" + fontSize;
    } // optionalAttrs (cfg.theme != null) { gtk-theme-name = cfg.theme.name; }
    // optionalAttrs (cfg.iconTheme != null) {
      gtk-icon-theme-name = cfg.iconTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null) {
      gtk-cursor-theme-name = cfg.cursorTheme.name;
    } // optionalAttrs (cfg.cursorTheme != null && cfg.cursorTheme.size != null) {
      gtk-cursor-theme-size = cfg.cursorTheme.size;
    };
  );
}
