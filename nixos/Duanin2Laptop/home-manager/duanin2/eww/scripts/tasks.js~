#!/usr/bin/env -S nix shell nixpkgs#nodejs_20 -c node
const timers = require('node:timers/promises')
const execFile = require('node:util').promisify(require('node:child_process').execFile)

async function focus(window, focusedWorkspace) {
    let command = `hyprctl --batch "keyword general:no_cursor_warps true;`

    if (window.workspace.id < 0) {
				command += `dispatch movetoworkspacesilent ${focusedWorkspace.id},address:${window.address};`
    }
    command += `dispatch focuswindow address:${window.address};`
    command += `keyword general:no_cursor_warps false"`
    return command
}
async function minimize(window) {
    return `hyprctl dispatch movetoworkspacesilent special,address:${window.address}`
}
async function close(window) {
    return `hyprctl dispatch closewindow address:${window.address}`
}

async function genJSON() {
    const windows = JSON.parse((await execFile('hyprctl', ['clients', '-j'])).stdout)
    const focusedWorkspace = JSON.parse((await execFile('hyprctl', ['activeworkspace', '-j'])).stdout)

    const focusedWindow = JSON.parse((await execFile('hyprctl', ['activewindow', '-j'])).stdout)

    let out = []

    for (window of windows) {
        if (window.class == '') {
            continue
				}
				out[out.length] = {
						isFocused: (focusedWindow.address == window.address) ? true : false,
						focus: await focus(window, focusedWorkspace),
						minimize: await minimize(window),
						close: await close(window),
						title: window.title
				}
		}
    out = JSON.stringify(out)
    return out
}

(async function() {
    let prevJson
    for await (const json of timers.setInterval(1000, genJSON)) {
				jsonRes = await json()
				if (prevJson === jsonRes) {
						continue
				}
				prevJson = jsonRes
				console.log(jsonRes)
    }
})()
